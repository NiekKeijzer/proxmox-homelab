---
- hosts: all
  roles: 
    - role: geerlingguy.security
      security_sudoers_passwordless: ['mrrobot']
      security_autoupdate_enabled: true

- hosts: dns
  roles: 
    - role: geerlingguy.firewall
      firewall_allowed_tcp_ports:
        - 22
        - 53
        - 80
        - 443
        # Health check
        - 8080 
        # Metrics
        - 9153
      firewall_allowed_udp_ports:
        - 53
    - role: coredns
      vars: 
        # Create wildcard DNS for services in the auto generated zone
        # *.svc.burrow.casa pointing to docker-01 IP
        auto_zone_wildcard_domains:
          - domain: svc
            hosts: 
              - docker-01

- hosts: docker
  roles: 
    - role: geerlingguy.firewall
      firewall_allowed_tcp_ports:
        - 22
        - 80
        - 443
      firewall_additional_rules:
        - "iptables -I INPUT -i docker0 -j ACCEPT"
        - "iptables -I FORWARD -i docker0 -j ACCEPT"
        - "iptables -I FORWARD -o docker0 -j ACCEPT"
    - role: geerlingguy.docker
      docker_users:
        - mrrobot
      docker_install_compose_plugin: true
      docker_restart_handler_state: restarted
