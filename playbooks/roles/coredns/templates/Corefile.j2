# CoreDNS Configuration
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

. {
    # Log all queries
    log
    
    # Enable error logging
    errors
    
    # Cache responses
    cache {{ cache_ttl }}
    
    # Forward to upstream DNS servers
    forward . {{ forward_servers | join(' ') }} {
        max_concurrent 1000
    }
    
    # Reload configuration automatically
    reload
    
    # Enable prometheus metrics
    prometheus {{ coredns_metrics_interface }}:{{ coredns_metrics_port }}
    
    # Respond to health checks
    health {{ coredns_health_interface }}:{{ coredns_health_port }}
}

{% if auto_zone_enabled %}
# Auto-generated zone from Ansible inventory
{{ auto_zone_name }} {
    file {{ coredns_config_dir }}/zones/{{ auto_zone_name }}.zone
    log
    errors
    reload
}
{% endif %}

{% if custom_zones is defined and custom_zones | length > 0 %}
# Custom DNS Zones
{% for zone in custom_zones %}
{{ zone.name }} {
    file {{ coredns_config_dir }}/zones/{{ zone.zone_file }}
    log
    errors
    reload
}

{% endfor %}
{% endif %}