; Auto-generated zone file for {{ auto_zone_name }}
; Generated by Ansible on {{ ansible_date_time.iso8601 }}
; Contains {{ groups['all'] | length }} hosts from inventory

$ORIGIN {{ auto_zone_name }}.
$TTL {{ cache_ttl }}

; SOA Record
@ IN SOA ns1.{{ auto_zone_name }}. {{ 'admin.' ~ auto_zone_name }}. (
    {{ ansible_date_time.epoch }} ; Serial (timestamp)
    3600       ; Refresh
    1800       ; Retry
    604800     ; Expire
    86400      ; Minimum TTL
)

; NS Record
@ IN NS ns1.{{ auto_zone_name }}.

; DNS Server itself
{% for host in groups['dns'] %}
ns{{ loop.index }} IN A {{ hostvars[host]['ansible_default_ipv4']['address'] }}
{% endfor %}

; All inventory hosts
{% for host in groups['all'] %}
{% if hostvars[host]['ansible_default_ipv4']['address'] is defined %}
{{ host | replace('.', '-') }} IN A {{ hostvars[host]['ansible_default_ipv4']['address'] }}
{% endif %}
{% endfor %}

; Group-based records
{% for group in groups.keys() %}
{% if group != 'all' and group != 'ungrouped' %}

; {{ group }} group
{% for host in groups[group] %}
{% if hostvars[host]['ansible_default_ipv4']['address'] is defined %}
{{ host | replace('.', '-') }}.{{ group }} IN A {{ hostvars[host]['ansible_default_ipv4']['address'] }}
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}

{% if auto_zone_wildcard_domains is defined and auto_zone_wildcard_domains | length > 0 %}
; Wildcard DNS Records
{% for wildcard in auto_zone_wildcard_domains %}

; Wildcard for {{ wildcard.domain }}
{% set wc_domain = wildcard.domain %}
{% set wc_ips = [] %}

{# Collect IPs from specific hosts list #}
{% if wildcard.hosts is defined and wildcard.hosts | length > 0 %}
    {% for hostname in wildcard.hosts %}
        {% if hostvars[hostname] is defined and hostvars[hostname]['ansible_default_ipv4']['address'] is defined %}
            {% set _ = wc_ips.append(hostvars[hostname]['ansible_default_ipv4']['address']) %}
        {% endif %}
    {% endfor %}
{% endif %}

{# Generate wildcard records #}
{% for ip in wc_ips %}
*.{{ wc_domain }} IN A {{ ip }}
{% endfor %}
{% endfor %}
{% endif %}

